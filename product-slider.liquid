<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<div class="swiper real-infinite-coverflow">
  <div class="swiper-wrapper">
    {% assign collection_handle = section.settings.collection %}
    {% assign products = collections[collection_handle].products %}
    {% for product in products limit: section.settings.limit %}
      <div class="swiper-slide">
        <div class="slide-card">
          <a href="{{ product.url }}">
            <div class="slide-img-bg">
              <img src="{{ product.featured_image | img_url: '600x600' }}" alt="{{ product.title }}">
              {% assign now = 'now' | date: '%s' %}
              {% assign product_created = product.created_at | date: '%s' %}
              {% assign days_since_created = now | minus: product_created | divided_by: 86400 | abs %}
              {% if days_since_created < 14 %}
                <span class="badge-new">Nouveau</span>
              {% endif %}
            </div>
            <div class="slide-card-content">
              <h3>{{ product.title | truncate: 45 }}</h3>
              <div class="slide-price">{{ product.price | money }}</div>
              <form method="post" action="/cart/add" class="add-to-cart-form">
                <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                <button type="submit" class="add-to-cart-btn">Ajouter au panier</button>
              </form>
            </div>
          </a>
        </div>
      </div>
    {% endfor %}
    {% comment %}
    -- Pour le mode loop VRAIMENT infini, il faut que Swiper ait assez de slides. 
       Donc on duplique les slides si jamais il n’y en a que 2 ou 3.
    {% endcomment %}
    {% if products.size < 4 %}
      {% for product in products limit: section.settings.limit %}
        <div class="swiper-slide">
          <div class="slide-card">
            <a href="{{ product.url }}">
              <div class="slide-img-bg">
                <img src="{{ product.featured_image | img_url: '600x600' }}" alt="{{ product.title }}">
                {% assign now = 'now' | date: '%s' %}
                {% assign product_created = product.created_at | date: '%s' %}
                {% assign days_since_created = now | minus: product_created | divided_by: 86400 | abs %}
                {% if days_since_created < 14 %}
                  <span class="badge-new">Nouveau</span>
                {% endif %}
              </div>
              <div class="slide-card-content">
                <h3>{{ product.title | truncate: 45 }}</h3>
                <div class="slide-price">{{ product.price | money }}</div>
                <form method="post" action="/cart/add" class="add-to-cart-form">
                  <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                  <button type="submit" class="add-to-cart-btn">Ajouter au panier</button>
                </form>
              </div>
            </a>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div class="swiper-pagination"></div>
  <div class="swiper-button-next"></div>
  <div class="swiper-button-prev"></div>
</div>

<style>
.real-infinite-coverflow {
  width: 100%;
  padding: 64px 0 70px 0;
  background: linear-gradient(135deg,#a4baff 0,#d8b6ff 100%);
  border-radius: 40px;
  box-shadow: 0 6px 36px #d0d6f6;
  overflow: hidden;
  position: relative;
}
.swiper {
  overflow: visible;
}
.swiper-slide {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  width: 240px !important;
  max-width: 240px !important;
  min-width: 200px !important;
  transition: transform 0.18s;
}
.slide-card {
  width: 230px;
  height: 350px;
  background: #fff;
  border-radius: 22px;
  box-shadow: 0 10px 40px 0 #bbb8f330;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: box-shadow 0.18s;
  position: relative;
}
.slide-card:hover {
  box-shadow: 0 16px 48px #6c9ef5a0;
}
.slide-img-bg {
  width: 100%;
  height: 61%;
  overflow: hidden;
  position: relative;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  background: #e7eaff;
}
.slide-img-bg img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.badge-new {
  position: absolute;
  top: 16px;
  left: 16px;
  background: #fe6646;
  color: #fff;
  font-size: 0.9rem;
  font-weight: 700;
  padding: 4px 11px;
  border-radius: 13px;
  box-shadow: 0 2px 8px #ffdfd4;
  letter-spacing: 1px;
  z-index: 2;
}
.slide-card-content {
  padding: 15px 14px 12px 14px;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  background: linear-gradient(0deg, #fff 85%, #fff0 100%);
}
.slide-card h3 {
  font-size: 1.01rem;
  font-weight: 700;
  color: #172a53;
  margin: 0 0 8px 0;
  min-height: 2.1em;
  text-shadow: 0 2px 12px #fff,0 1px 2px #dde;
}
.slide-price {
  color: #2066e6;
  font-size: 1.13rem;
  font-weight: 800;
  margin-bottom: 7px;
  text-shadow: 0 2px 8px #fff;
}
.add-to-cart-form { width: 100%; }
.add-to-cart-btn {
  width: 100%;
  background: #2066e6;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 0;
  font-weight: 600;
  font-size: .99rem;
  cursor: pointer;
  transition: background 0.18s, transform 0.12s;
  box-shadow: 0 1px 8px #c0d8ff;
  margin-top: 2px;
}
.add-to-cart-btn:hover { background: #183ca5; transform: scale(1.03); }
.swiper-button-next, .swiper-button-prev {
  color: #2066e6;
  background: #fff;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  box-shadow: 0 2px 8px #d2e6ff;
  top: 53%;
}
.swiper-pagination-bullet-active {
  background: #2066e6 !important;
}
.swiper-slide-active .slide-card {
  box-shadow: 0 18px 60px #8ca3e5c7;
  transform: scale(1.06);
  z-index: 2;
}
@media (max-width: 900px) {
  .slide-card, .swiper-slide { width: 69vw !important; height: 54vw; max-width: 320px; max-height: 400px; }
  .real-infinite-coverflow { padding: 22px 0 28px 0; border-radius: 16px; }
}
@media (max-width: 600px) {
  .slide-card, .swiper-slide { width: 93vw !important; height: 64vw; max-width: 99vw; min-width: 86vw; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var totalSlides = document.querySelectorAll('.real-infinite-coverflow .swiper-slide').length;
  // Astuce : pour loop VRAIMENT infini, il faut que loopedSlides > slidesPerView*2
  var slidesToLoop = totalSlides > 6 ? totalSlides : 6;
  var swiper = new Swiper('.real-infinite-coverflow', {
    effect: "coverflow",
    grabCursor: true,
    centeredSlides: true,
    slidesPerView: "auto",
    initialSlide: 0,
    loop: true,
    loopedSlides: slidesToLoop,
    watchSlidesProgress: true,
    coverflowEffect: {
      rotate: 0,
      stretch: 0,
      depth: 340,
      modifier: 1.13,
      slideShadows: false
    },
    autoplay: {
      delay: 2500,
      disableOnInteraction: false
    },
    speed: 650,
    pagination: { el: ".swiper-pagination", clickable: true },
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev"
    }
  });
});
</script>

{% schema %}
{
  "name": "Slider de produits",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Nos produits phares"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection à afficher"
    },
    {
      "type": "number",
      "id": "limit",
      "label": "Nombre de produits à afficher",
      "default": 5
    }
  ],
  "presets": [
    {
      "name": "Slider de produits"
    }
  ]
}
{% endschema %}
